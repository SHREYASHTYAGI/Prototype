<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Bus Tracking</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root { --bg:#f5f6f8; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#111827; }
    body { margin:0; font-family: Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { background:#fff; color:var(--text); padding:1rem 1.5rem; text-align:center; font-size:1.4rem; font-weight:700; border-bottom:1px solid var(--border); }
    .container { display:flex; height: calc(100vh - 64px); }
    #info { width: 360px; padding: 1rem; background:#fff; border-right:1px solid var(--border); overflow-y:auto; }
    #map { flex:1; height: 100%; }
    h3 { margin:0 0 .75rem 0; font-size:1rem; font-weight:700; }
    .bus-card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:1rem; margin:.75rem 0; }
    .bus-header { font-size:1rem; font-weight:700; margin-bottom:.5rem; }
    .bus-details { font-size:.9rem; color:var(--muted); line-height:1.4; }
    .status-live { color:#10b981; font-weight:700; }
    .status-stopped { color:#dc2626; font-weight:700; }
    .no-buses { text-align:center; color:var(--muted); padding:1.25rem; font-style:italic; }
    .refresh-btn { position: fixed; top: 90px; right: 20px; background: var(--accent); color:#fff; border:1px solid var(--accent); padding:.6rem .9rem; border-radius: 8px; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,.15); }
  </style>
</head>
<body>
  <header>Live Bus Tracking</header>
  <div class="container">
    <div id="info">
      <h3>Available Buses</h3>
      <div id="busList">Loading bus data...</div>
    </div>
    <div id="map"></div>
  </div>
  <button class="refresh-btn" onclick="refreshBuses()">Refresh</button>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize map
    const map = L.map('map').setView([28.6139, 77.2090], 6); // Default center: Delhi

    // Tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    // Function: Get coordinates using OpenStreetMap Nominatim API
    async function getCoordinates(city) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
      const data = await response.json();
      if (data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        return null;
      }
    }

    async function showLiveBus() {
      const busListDiv = document.getElementById("busList");
      busListDiv.innerHTML = "";

      const busData = localStorage.getItem("liveBus");

      if (!busData) {
        busListDiv.innerHTML = "<p>‚ùå No live bus available right now.</p>";
        return;
      }

      const bus = JSON.parse(busData);

      // Display bus info
      const div = document.createElement("div");
      div.className = "bus-card";
      div.innerHTML = `
        <strong>${bus.start} ‚Üí ${bus.end}</strong><br>
        üöå Bus Number: ${bus.id} <br>
        üéü Seats: ${bus.seats} <br>
        üïí Departure: ${bus.time}
      `;
      busListDiv.appendChild(div);

      // Show route on map
      const startCoords = await getCoordinates(bus.start);
      const endCoords = await getCoordinates(bus.end);

      if (startCoords && endCoords) {
        L.marker(startCoords).addTo(map).bindPopup("Boarding: " + bus.start).openPopup();
        L.marker(endCoords).addTo(map).bindPopup("Destination: " + bus.end);
        const routeLine = L.polyline([startCoords, endCoords], { color: "blue" }).addTo(map);
        map.fitBounds(routeLine.getBounds());
      }
    }

    showLiveBus();
  </script>
</body>
</html>
